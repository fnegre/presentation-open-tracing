// Variables prédéfinis asciidoc
:author: Florian Nègre
:twitter: @floriannegre
:imagesDir: assets/images
// variables perso
:videosDir: assets/videos
:imageMaxHeight: 700

// Configuration Reveal.js
:revealjs_history: true

= Présentation Open Tracing

{author}

Twitter : {twitter}

Github : fnegre

Nantes JUG : 10/04/2018

== Imaginons...

video::/{videosDir}/giphy_rick_roll.mp4[]

[NOTE.speaker]
--
Mise en scène 1 : giphy n'affiche plus les gifs : oh my god!!
Faire une video où on va sur le site de Giphy, on cherche cat, et là ça affiche des photos de Trump à la place
Utilisation de Fiddler pour créer un proxy :
```
static function OnBeforeRequest(oSession: Session) {
    if (oSession.uriContains("/media/")) {
        oSession.fullUrl = "https://media.giphy.com/media/Vuw9m5wXviFIQ/giphy.gif";
    }
}
```
--


== Architecture

[ditaa]
....
                         +-------------+
                         |     IHM     |
                         +-------------+
                                |
                                | Requête
                                v
                         +------+------+
                         |     Back    |
                         +-------------+
                                |
                                | Requête
                                v
                         +------+------+
                         |   Service   |
                         |     GIF     |
                         +-------------+

....

[NOTE.speaker]
--
Schéma Ditaa
--

== Comment trouver la source de l'anomalie ?


== Scénario 1 : Aucun outil


[NOTE.speaker]
--
Grep, téléchargement de centaines de mo de logs, pb pour ouvrir le fichier...
--

== Scénario 2 : Aggrégation des logs

[NOTE.speaker]
--
elk sans id corrélation
C'est mieux, mais reste galère, on ne peut pas faire le lien entre les access logs et les logs applicatifs
--

== Scénario 3 : Identifiants de corrélation

[NOTE.speaker]
--
Top moumoute
--

== Principe
image::schema-propagation-id-correlation.png[Schéma propagation id corrélation]

[NOTE.speaker]
--
Expliquer le principe d'un identifiant de corrélation +
Génération et transmission via header pour une requête http +
Ajouter dans tous les logs (applicatif, access log, etc.) pour qu'il soit visible dans l'outil d'aggrégation de logs
--

== Google Dapper

* Trace-id : identifiant commun
* Span-id : identifiant propre à une opération

[NOTE.speaker]
--
Document de travail : Google Dapper (2010) https://research.google.com/pubs/pub36356.html
Mais aussi :
Parent-span-id : identifiant du span parent
--

[transition=none]
[%notitle]
== Propagation - etape 1
image::propagation/01.png[Schéma propagation id corrélation, height={imageMaxHeight}]

[transition=none]
[%notitle]
== Propagation - etape 2
image::propagation/02.png[Schéma propagation id corrélation, height={imageMaxHeight}]

[transition=none]
[%notitle]
== Propagation - etape 3
image::propagation/03.png[Schéma propagation id corrélation, height={imageMaxHeight}]

[transition=none]
[%notitle]
== Propagation - etape 4
image::propagation/04.png[Schéma propagation id corrélation, height={imageMaxHeight}]

[transition=none]
[%notitle]
== Propagation - etape 5
image::propagation/05.png[Schéma propagation id corrélation, height={imageMaxHeight}]

[transition=none]
[%notitle]
== Propagation - etape 6
image::propagation/06.png[Schéma propagation id corrélation, height={imageMaxHeight}]

[transition=none]
[%notitle]
== Propagation - etape 7
image::propagation/07.png[Schéma propagation id corrélation, height={imageMaxHeight}]

== Implémentations
:revealjs_transition: slide

== A la mimine

[NOTE.speaker]
--
Filtre servlet, intercepteur, ajouter les ids dans le MDC de l'outil de log, thread local
--

== Bibliothèques


== Spring Cloud Sleuth

[NOTE.speaker]
--
https://github.com/spring-cloud/spring-cloud-sleuth
Starter pour Spring Boot
Gestion transparente de l’envoi/réception des headers de traçage via RestTemplate et RestController
Intégration automatique des ids de corrélation dans le MDC des librairies de logs
// TODO noter le nom des entêtes http utilisés
--

== Brave

[NOTE.speaker]
--
https://github.com/openzipkin/brave
Avantages : Compatibilité java 6d
De nombreux modules existent pour faciliter l'intégration avec d'autres bibliothèques.
Ex : Spring MVC, Jersey

--

== Nouveau problème

[%notitle]
== C'est lent...
video::/{videosDir}/giphy-lent.mp4[]

[NOTE.speaker]
--
giphy est lent, d'où vient la lenteur ?
.Code Fiddler
```
if (oSession.uriContains("giphy")) {
    // Delay sends by 100ms per KB uploaded.
    oSession["request-trickle-delay"] = "100";
    // Delay receives by 150ms per KB downloaded.
    oSession["response-trickle-delay"] = "150";
}
```
--

== Zzzz ...


== Zipkin

[NOTE.speaker]
--
Outil de visualisation des traces
Sleuth et brave communiquent avec Zipkin
--

== Evénements

//  TODO remplacer par un schéma des événements CS, SR, SS, CR

4 étapes dans un Span

 * Client Sent
 * Server received
 * Server sent
 * Client Received


== Vidéo zipkin

// TODO Vidéo Zipkin


== Quelques mois plus tard...

[NOTE.speaker]
--
Obsoléscence des outils
peut être dans 6 mois, 1 an, vous découvrez que Brave a une fuite mémoire, ou que Zipkin plante,
Le projet est mort, pas maintenu
Vous allez devoir jeter tout ce qui a été développé, et le développez avec un nouvel outil ??
Aie aie aie
--

== La Solution...

== Open tracing

==  Façade

== Implémentations multiples
[NOTE.speaker]
--
Plusieurs langages de programmation : Java, Go, PHP, Node.js, .NET
Façade tel SLF4J pour le logging
http://opentracing.io/documentation/pages/api/api-implementations.html
https://medium.com/opentracing
--

== Zipkin, Jaeger, Lithstep...

[NOTE.speaker]
--
https://github.com/opentracing-contrib
https://github.com/openzipkin-contrib/brave-opentracing

--

== Qui l'utilise ?

// TODO Mettre logos des entreprises

[NOTE.speaker]
--
Uber, Apple, Yelp, Pinterest, Yelp ...
--

== Cloud Native Computing Fundation

https://www.cncf.io/

[NOTE.speaker]
--

Promotion des solutions open source permettant de construire des applications distribuées et résilientes
Chapoté par Linux Foundation
Autres projets : Kubernetes, Prometheus, Grpc, ...
https://www.cncf.io/

--


== Pour finir

[NOTE.speaker]
--
* Traçage des requêtes indispensables
* Ne pas réinventer la roue
* Outils relativement jeunes, risqué de parier sur un outil
* Open Tracing est une bonne solution
--

== Merci

== Questions & infos

https://github.com/fnegre/presentation-open-tracing

Twitter : {twitter}


